<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- å¾®ä¿¡æµè§ˆå™¨å…¼å®¹æ€§ -->
  <meta name="applicable-device" content="mobile">
  <meta name="mobile-agent" content="format=html5; url=https://m.example.com">
  <title>ç­”é¢˜æ¸¸æˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .game-title {
      font-size: 1.8rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .user-info {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      backdrop-filter: blur(5px);
    }

    .content {
      padding: 30px;
      min-height: 400px;
    }

    .join-form {
      max-width: 400px;
      margin: 0 auto;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e1e8ed;
      border-radius: 10px;
      font-size: 16px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .join-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      font-weight: 600;
    }

    .join-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .join-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #ffe6e6;
      color: #d63031;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #d63031;
    }

    .waiting {
      text-align: center;
      padding: 40px;
      display: none;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .quiz-container {
      display: none;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9ff 0%, #e8f4fd 100%);
      border-radius: 15px;
      border: 2px solid #e1e8ed;
    }

    .question-number {
      font-size: 1.2rem;
      font-weight: bold;
      color: #667eea;
    }

    .question-timer {
      background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
      color: white;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
      transition: all 0.3s ease;
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 4px 15px rgba(255, 23, 68, 0.3);
      }

      100% {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 23, 68, 0.5);
      }
    }

    .score-display {
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
      color: #2d3436;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      font-size: 1.1rem;
      box-shadow: 0 4px 15px rgba(253, 203, 110, 0.3);
    }

    .question {
      font-size: 1.3rem;
      margin-bottom: 30px;
      line-height: 1.6;
      color: #2d3436;
      font-weight: 600;
    }

    .options {
      display: grid;
      gap: 15px;
    }

    .option {
      background: white;
      border: 2px solid #e1e8ed;
      border-radius: 15px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
      font-size: 1.1rem;
    }

    .option:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .option.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .option.correct {
      border-color: #00b894;
      background: linear-gradient(135deg, #00b894 0%, #55a3ff 100%);
      color: white;
    }

    .option.wrong {
      border-color: #e17055;
      background: linear-gradient(135deg, #e17055 0%, #fd79a8 100%);
      color: white;
    }

    .option-letter {
      background: rgba(255, 255, 255, 0.2);
      color: inherit;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      flex-shrink: 0;
    }

    .option.selected .option-letter,
    .option.correct .option-letter,
    .option.wrong .option-letter {
      background: rgba(255, 255, 255, 0.3);
      color: white;
    }

    .answer-feedback {
      margin-top: 20px;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      font-size: 1.1rem;
      line-height: 1.6;
      display: none;
    }

    .answer-feedback.correct {
      background: linear-gradient(135deg, #00b894 0%, #55a3ff 100%);
      color: white;
    }

    .answer-feedback.wrong {
      background: linear-gradient(135deg, #e17055 0%, #fd79a8 100%);
      color: white;
    }

    .rank-display {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px 20px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      font-weight: bold;
      color: #667eea;
      z-index: 1000;
      border: 2px solid #e1e8ed;
    }

    .result-container {
      display: none;
      text-align: center;
    }

    .final-score {
      font-size: 3rem;
      font-weight: bold;
      color: #667eea;
      margin: 20px 0;
    }

    .final-score-preview {
      text-align: center;
      margin: 30px 0;
    }

    .final-score-preview .score {
      font-size: 4rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .final-score-preview div:last-child {
      font-size: 1.2rem;
      color: #636e72;
      font-weight: 600;
    }

    .leaderboard {
      margin-top: 30px;
    }

    .leaderboard-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: white;
      border: 2px solid #e1e8ed;
      border-radius: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
    }

    .leaderboard-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
    }

    .leaderboard-item.current-user {
      border-color: #fdcb6e;
      background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
    }

    .leaderboard-rank {
      font-size: 1.2rem;
      font-weight: bold;
      color: #667eea;
      width: 40px;
    }

    .leaderboard-info {
      flex: 1;
      text-align: left;
      margin-left: 15px;
    }

    .leaderboard-name {
      font-weight: bold;
      color: #2d3436;
    }

    .leaderboard-details {
      font-size: 0.9rem;
      color: #636e72;
      margin-top: 2px;
    }

    .leaderboard-score {
      font-size: 1.3rem;
      font-weight: bold;
      color: #00b894;
    }

    .debug-info {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      max-width: 300px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .debug-toggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #2d3436;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 20px;
      cursor: pointer;
      z-index: 1001;
      font-size: 12px;
    }

    .connection-status {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 10px 15px;
      border-radius: 20px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      font-size: 14px;
    }

    .connection-status.connected {
      background: linear-gradient(135deg, #00b894 0%, #55a3ff 100%);
    }

    .connection-status.disconnected {
      background: linear-gradient(135deg, #e17055 0%, #fd79a8 100%);
    }

    .connection-status.connecting {
      background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
    }

    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .container {
        border-radius: 15px;
      }

      .header {
        padding: 20px;
      }

      .game-title {
        font-size: 1.5rem;
      }

      .content {
        padding: 20px;
      }

      .question-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .question {
        font-size: 1.1rem;
      }

      .option {
        padding: 15px;
        font-size: 1rem;
      }

      .rank-display {
        position: static;
        margin-bottom: 20px;
        width: 100%;
      }

      .final-score {
        font-size: 2.5rem;
      }

      .final-score-preview .score {
        font-size: 3rem;
      }

      .debug-info {
        font-size: 10px;
        max-width: 250px;
      }
    }

    /* å¾®ä¿¡æµè§ˆå™¨ä¼˜åŒ– */
    @media screen and (max-width: 480px) {

      .question-timer,
      .score-display {
        padding: 8px 15px;
        font-size: 1rem;
      }

      .leaderboard-item {
        padding: 12px 15px;
      }

      .leaderboard-rank {
        font-size: 1.1rem;
        width: 35px;
      }

      .leaderboard-score {
        font-size: 1.2rem;
      }
    }
  </style>
</head>

<body>
  <!-- è°ƒè¯•ä¿¡æ¯ -->
  <div class="debug-info" id="debugInfo">è°ƒè¯•ä¿¡æ¯...</div>

  <!-- è¿æ¥çŠ¶æ€ -->
  <div class="connection-status connecting" id="connectionStatus">è¿æ¥ä¸­...</div>

  <div class="container">
    <div class="header">
      <h1>ğŸ¯ ç­”é¢˜æŒ‘æˆ˜</h1>
      <div class="game-info">
        <span>ğŸ“š 15é“é¢˜ç›®ï¼Œæ¯é¢˜10ç§’é™æ—¶</span>
        <span>åˆ†æ•°: <span id="scoreDisplay">0</span></span>
        <span>æ’å: <span id="rankDisplay">-</span></span>
      </div>
    </div>

    <div class="content">
      <!-- ç™»å½•è¡¨å• -->
      <div class="login-form" id="loginForm">
        <h2>å¼€å§‹ç­”é¢˜æŒ‘æˆ˜</h2>
        <p style="color: #666; margin-bottom: 25px; font-size: 0.95rem;">
          ğŸ“ å¡«å†™ä¿¡æ¯åç«‹å³å¼€å§‹15é“é¢˜ç­”é¢˜æŒ‘æˆ˜<br>
          â±ï¸ æ¯é¢˜é™æ—¶10ç§’ï¼Œç­”å¯¹å¾—10åˆ†ï¼Œç­”é”™æ‰£15åˆ†
        </p>
        <div class="input-group">
          <input type="text" id="nameInput" placeholder="è¯·è¾“å…¥çœŸå®å§“å" maxlength="20" required>
        </div>
        <div class="input-group">
          <input type="text" id="studentIdInput" placeholder="è¯·è¾“å…¥å­¦å·" maxlength="20" required>
        </div>
        <div class="error-message" id="errorMessage" style="display: none;"></div>
        <button class="btn" onclick="joinGame()">ğŸš€ ç«‹å³å¼€å§‹ç­”é¢˜</button>
      </div>

      <!-- ç­‰å¾…æ¸¸æˆå¼€å§‹ -->
      <div class="waiting" id="waiting">
        <h2>ç­‰å¾…æ¸¸æˆå¼€å§‹...</h2>
        <div class="spinner"></div>
        <p>æ‚¨å·²æˆåŠŸåŠ å…¥æ¸¸æˆï¼Œè¯·è€å¿ƒç­‰å¾…ç®¡ç†å‘˜å¼€å§‹æ¸¸æˆã€‚</p>
      </div>

      <!-- ç­”é¢˜ç•Œé¢ -->
      <div class="quiz-container" id="quizContainer">
        <div class="question-header">
          <span class="question-number" id="questionNumber">é¢˜ç›® 1/10</span>
          <span class="timer" id="questionTimer">30s</span>
        </div>

        <div class="question" id="questionText">
          é¢˜ç›®åŠ è½½ä¸­...
        </div>

        <div class="answer-feedback" id="answerFeedback">
        </div>

        <div class="options" id="optionsContainer">
          <!-- é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="score-display" id="currentScore">
          <div class="score">0</div>
          <div>å½“å‰å¾—åˆ†</div>
        </div>
      </div>

      <!-- ç»“æœé¡µé¢ -->
      <div class="result-container" id="resultContainer">
        <h2>ğŸ‰ æ¸¸æˆç»“æŸ</h2>

        <div class="final-score">
          <div class="score" id="finalScore">0</div>
          <div>æœ€ç»ˆå¾—åˆ†</div>
        </div>

        <div class="rank-display" id="finalRank">
          æ‚¨çš„æ’å: ç¬¬ 0 å
        </div>

        <div class="leaderboard-mini">
          <h3>ğŸ† å‰ä¸‰å</h3>
          <div id="topThree">
            <!-- å‰ä¸‰åå°†é€šè¿‡JavaScriptæ˜¾ç¤º -->
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
          <p style="color: #666; margin: 0;">æ¸¸æˆå·²ç»“æŸï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
          <p style="color: #666; font-size: 0.9rem; margin: 5px 0 0 0;">å¦‚éœ€é‡æ–°ç­”é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜é‡æ–°å¼€å§‹æ¸¸æˆã€‚</p>
        </div>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // è°ƒè¯•åŠŸèƒ½
    let debugMode = window.location.search.includes('debug=true');
    let debugInfo = document.getElementById('debugInfo');
    let connectionStatus = document.getElementById('connectionStatus');

    if (debugMode) {
      debugInfo.style.display = 'block';
    }

    function log(message) {
      console.log(message);
      if (debugMode) {
        debugInfo.innerHTML += '<br>' + message;
        debugInfo.scrollTop = debugInfo.scrollHeight;
      }
    }

    function updateConnectionStatus(status, message) {
      connectionStatus.className = `connection-status ${status}`;
      connectionStatus.textContent = message;
      log(`è¿æ¥çŠ¶æ€: ${status} - ${message}`);
    }

    // Socket.io è¿æ¥é…ç½® - å¢å¼ºå¾®ä¿¡å…¼å®¹æ€§
    const socket = io({
      timeout: 20000,
      forceNew: true,
      reconnection: true,
      reconnectionDelay: 1000,
      reconnectionAttempts: 5,
      transports: ['websocket', 'polling'] // å¾®ä¿¡å…¼å®¹æ€§
    });

    let currentUser = null;
    let currentQuestion = null;
    let questionStartTime = null;
    let questionTimer = null;
    let timeLeft = 30;
    let roomId = window.location.pathname.split('/')[2] || 'main-room'; // å¦‚æœæ²¡æœ‰æŒ‡å®šroomIdï¼Œä½¿ç”¨é»˜è®¤çš„'main-room'
    log(`æˆ¿é—´ID: ${roomId}`);

    // é¡µé¢å…ƒç´ 
    const loginForm = document.getElementById('loginForm');
    const waiting = document.getElementById('waiting');
    const quizContainer = document.getElementById('quizContainer');
    const resultContainer = document.getElementById('resultContainer');
    const userDisplay = document.getElementById('userDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const rankDisplay = document.getElementById('rankDisplay');
    const nameInput = document.getElementById('nameInput');
    const studentIdInput = document.getElementById('studentIdInput');

    // Socketè¿æ¥äº‹ä»¶
    socket.on('connect', () => {
      updateConnectionStatus('connected', 'å·²è¿æ¥');
      log('Socketè¿æ¥æˆåŠŸ');
    });

    socket.on('disconnect', () => {
      updateConnectionStatus('disconnected', 'è¿æ¥æ–­å¼€');
      log('Socketè¿æ¥æ–­å¼€');
    });

    socket.on('connect_error', (error) => {
      updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
      log(`è¿æ¥é”™è¯¯: ${error.message}`);
    });

    socket.on('reconnecting', (attemptNumber) => {
      updateConnectionStatus('connecting', `é‡è¿ä¸­(${attemptNumber})`);
      log(`æ­£åœ¨é‡è¿ï¼Œå°è¯•æ¬¡æ•°: ${attemptNumber}`);
    });

    // åŠ å…¥æ¸¸æˆ
    function joinGame() {
      const name = nameInput.value.trim();
      const studentId = studentIdInput.value.trim();
      const errorMessage = document.getElementById('errorMessage');

      // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯æ¶ˆæ¯
      errorMessage.style.display = 'none';
      errorMessage.textContent = '';

      if (!name || !studentId) {
        errorMessage.textContent = 'è¯·å¡«å†™å®Œæ•´çš„å§“åå’Œå­¦å·';
        errorMessage.style.display = 'block';
        return;
      }

      if (name.length < 2) {
        errorMessage.textContent = 'å§“åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦';
        errorMessage.style.display = 'block';
        return;
      }

      if (studentId.length < 5) {
        errorMessage.textContent = 'å­¦å·æ ¼å¼ä¸æ­£ç¡®ï¼Œè‡³å°‘5ä½';
        errorMessage.style.display = 'block';
        return;
      }

      log(`å°è¯•åŠ å…¥æ¸¸æˆï¼Œå§“å: ${name}, å­¦å·: ${studentId}, æˆ¿é—´: ${roomId}`);

      socket.emit('joinGame', {
        name,
        studentId,
        roomId
      });

      // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
      const joinBtn = document.querySelector('.login-form .btn');
      joinBtn.disabled = true;
      joinBtn.textContent = 'åŠ å…¥ä¸­...';
    }

    // Socketäº‹ä»¶ç›‘å¬
    socket.on('joinSuccess', (data) => {
      currentUser = data.user;

      // æ›´æ–°å¤´éƒ¨ä¿¡æ¯æ˜¾ç¤ºç”¨æˆ·
      const gameInfo = document.querySelector('.game-info');
      gameInfo.innerHTML = `
        <span>ç”¨æˆ·: ${currentUser.name}(${currentUser.studentId})</span>
        <span>åˆ†æ•°: <span id="scoreDisplay">0</span></span>
        <span>æ’å: <span id="rankDisplay">-</span></span>
      `;

      log(`åŠ å…¥æ¸¸æˆæˆåŠŸï¼Œç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(currentUser)}`);
      log(`æ¸¸æˆçŠ¶æ€: ${JSON.stringify(data.gameState)}`);

      loginForm.style.display = 'none';

      if (data.gameState.isActive) {
        // æ¸¸æˆå·²ç»å¼€å§‹ï¼Œç­‰å¾…æœåŠ¡å™¨å‘é€å½“å‰é¢˜ç›®
        log('æ¸¸æˆå·²å¼€å§‹ï¼Œç­‰å¾…æ¥æ”¶é¢˜ç›®');
        waiting.style.display = 'block';
      } else {
        // ç­‰å¾…æ¸¸æˆå¼€å§‹
        log('ç­‰å¾…æ¸¸æˆå¼€å§‹');
        waiting.style.display = 'block';
      }
    });

    socket.on('joinError', (data) => {
      log(`åŠ å…¥æ¸¸æˆå¤±è´¥: ${data.message}`);
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = data.message;
      errorMessage.style.display = 'block';

      // é‡æ–°å¯ç”¨æŒ‰é’®
      const joinBtn = document.querySelector('.login-form .btn');
      joinBtn.disabled = false;
      joinBtn.textContent = 'åŠ å…¥ç­”é¢˜';
    });

    socket.on('gameStarted', (data) => {
      log(`æ¥æ”¶åˆ°é¢˜ç›®: ${JSON.stringify(data)}`);
      waiting.style.display = 'none';
      quizContainer.style.display = 'block';

      showQuestion(data.question, data.questionNumber, data.totalQuestions);
    });

    socket.on('nextQuestion', (data) => {
      log(`ä¸‹ä¸€é¢˜: ${JSON.stringify(data)}`);
      showQuestion(data.question, data.questionNumber, data.totalQuestions, data.timeLimit);
    });

    socket.on('userCompleted', (data) => {
      log(`ç”¨æˆ·å®Œæˆæ‰€æœ‰é¢˜ç›®: ${JSON.stringify(data)}`);
      quizContainer.style.display = 'none';

      // æ˜¾ç¤ºå®Œæˆç­‰å¾…é¡µé¢
      const waitingCompleted = document.createElement('div');
      waitingCompleted.className = 'waiting';
      waitingCompleted.style.display = 'block';
      waitingCompleted.innerHTML = `
        <h2>ğŸ‰ æ­å–œå®Œæˆç­”é¢˜ï¼</h2>
        <div class="final-score-preview">
          <div class="score">${data.finalScore}</div>
          <div>æ‚¨çš„å¾—åˆ†</div>
        </div>
        <div style="margin: 20px 0;">
          <p>æ­£ç¡®é¢˜æ•°: ${data.correctAnswers}/${data.totalQuestions}</p>
          <p>æ­£ç¡®ç‡: ${Math.round((data.correctAnswers / data.totalQuestions) * 100)}%</p>
        </div>
        <div class="result-message">
          <p style="color: #4caf50; font-size: 1.2rem; font-weight: bold;">âœ… ç­”é¢˜å®Œæˆï¼</p>
          <p style="color: #666;">æ‚¨å¯ä»¥æŸ¥çœ‹æ’è¡Œæ¦œäº†è§£æ‚¨çš„æ’å</p>
        </div>
      `;

      document.querySelector('.content').appendChild(waitingCompleted);
    });

    socket.on('gameEnded', (data) => {
      log(`æ¸¸æˆç»“æŸäº‹ä»¶: ${JSON.stringify(data)}`);
      // ç§»é™¤å®Œæˆç­‰å¾…é¡µé¢
      const waitingCompleted = document.querySelector('.waiting');
      if (waitingCompleted) {
        waitingCompleted.remove();
      }

      quizContainer.style.display = 'none';
      resultContainer.style.display = 'block';

      showResults(data.finalLeaderboard);
    });

    socket.on('answerResult', (data) => {
      log(`ç­”æ¡ˆç»“æœ: ${JSON.stringify(data)}`);
      showAnswerFeedback(data);
      updateScore(data.totalScore);

      // ç­”é¢˜åé¦ˆæ˜¾ç¤º1.5ç§’åè‡ªåŠ¨éšè—ï¼ˆç­‰å¾…ä¸‹ä¸€é¢˜ï¼‰
      setTimeout(() => {
        const feedback = document.getElementById('answerFeedback');
        feedback.style.display = 'none';

        // é‡ç½®é€‰é¡¹çŠ¶æ€
        document.querySelectorAll('.option').forEach(option => {
          option.classList.remove('selected', 'correct', 'wrong');
          option.style.pointerEvents = 'auto';
        });

        // é‡ç½®è®¡æ—¶å™¨é¢œè‰²
        const timerElement = document.getElementById('questionTimer');
        timerElement.style.background = 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)';
        timerElement.style.animation = 'none';
      }, 1500);
    });

    socket.on('leaderboardUpdate', (leaderboard) => {
      log(`æ’è¡Œæ¦œæ›´æ–°: ${JSON.stringify(leaderboard)}`);
      updateRank(leaderboard);
    });

    socket.on('gameReset', (data) => {
      log(`æ¸¸æˆé‡ç½®: ${data.message}`);
      // æ˜¾ç¤ºé‡ç½®æç¤ºå¹¶é‡æ–°åŠ è½½é¡µé¢
      alert(data.message);
      location.reload();
    });

    // æ–°å¢ï¼šå¤„ç†è¶…æ—¶äº‹ä»¶
    socket.on('timeUp', (data) => {
      log(`è¶…æ—¶äº‹ä»¶: ${JSON.stringify(data)}`);
      showTimeUpFeedback(data);
      updateScore(data.totalScore);

      // åœæ­¢è®¡æ—¶å™¨
      if (questionTimer) {
        clearInterval(questionTimer);
        questionTimer = null;
      }

      // è¶…æ—¶åé¦ˆæ˜¾ç¤º1.5ç§’åè‡ªåŠ¨éšè—ï¼ˆç­‰å¾…ä¸‹ä¸€é¢˜ï¼‰
      setTimeout(() => {
        const feedback = document.getElementById('answerFeedback');
        feedback.style.display = 'none';

        // é‡ç½®é€‰é¡¹çŠ¶æ€
        document.querySelectorAll('.option').forEach(option => {
          option.classList.remove('selected', 'correct', 'wrong');
          option.style.pointerEvents = 'auto';
        });

        // é‡ç½®è®¡æ—¶å™¨é¢œè‰²
        const timerElement = document.getElementById('questionTimer');
        timerElement.style.background = 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)';
        timerElement.style.animation = 'none';
      }, 1500);
    });

    // æ˜¾ç¤ºé¢˜ç›®
    function showQuestion(question, questionNumber, totalQuestions, timeLimit = 10) {
      log(`æ˜¾ç¤ºé¢˜ç›®: ${question.question}`);

      currentQuestion = question;
      questionStartTime = Date.now();
      timeLeft = timeLimit; // ä½¿ç”¨æœåŠ¡å™¨ä¼ æ¥çš„æ—¶é—´é™åˆ¶

      // åœæ­¢ä¹‹å‰çš„è®¡æ—¶å™¨
      if (questionTimer) {
        clearInterval(questionTimer);
        questionTimer = null;
      }

      document.getElementById('questionNumber').textContent = `é¢˜ç›® ${questionNumber}/${totalQuestions}`;
      document.getElementById('questionText').textContent = question.question;

      // éšè—ç­”æ¡ˆåé¦ˆ
      document.getElementById('answerFeedback').style.display = 'none';

      // ç”Ÿæˆé€‰é¡¹
      const optionsContainer = document.getElementById('optionsContainer');
      optionsContainer.innerHTML = '';

      question.options.forEach((option, index) => {
        const optionElement = document.createElement('div');
        optionElement.className = 'option';
        optionElement.onclick = () => selectOption(index);

        optionElement.innerHTML = `
          <span class="option-letter">${String.fromCharCode(65 + index)}</span>
          <span>${option}</span>
        `;

        optionsContainer.appendChild(optionElement);
      });

      // å¼€å§‹è®¡æ—¶å™¨
      startQuestionTimer();
    }

    // é€‰æ‹©é€‰é¡¹
    function selectOption(index) {
      // ç§»é™¤ä¹‹å‰çš„é€‰æ‹©
      document.querySelectorAll('.option').forEach(option => {
        option.classList.remove('selected');
      });

      // é€‰ä¸­å½“å‰é€‰é¡¹
      const selectedOption = document.querySelectorAll('.option')[index];
      selectedOption.classList.add('selected');

      // ç«‹å³æäº¤ç­”æ¡ˆ
      submitAnswer(index);
    }

    // æäº¤ç­”æ¡ˆ
    function submitAnswer(answer) {
      if (!currentQuestion) return;

      const timeSpent = Math.round((Date.now() - questionStartTime) / 1000);

      // åœæ­¢è®¡æ—¶å™¨
      if (questionTimer) {
        clearInterval(questionTimer);
        questionTimer = null;
      }

      socket.emit('submitAnswer', {
        questionId: currentQuestion.id,
        answer: answer,
        timeSpent: timeSpent
      });
    }

    // æ˜¾ç¤ºç­”æ¡ˆåé¦ˆ
    function showAnswerFeedback(data) {
      const feedback = document.getElementById('answerFeedback');
      const options = document.querySelectorAll('.option');

      // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
      options.forEach((option, index) => {
        if (index === data.correctAnswer) {
          option.classList.add('correct');
        } else if (option.classList.contains('selected') && index !== data.correctAnswer) {
          option.classList.add('wrong');
        }
      });

      // æ˜¾ç¤ºåé¦ˆä¿¡æ¯
      feedback.className = `answer-feedback ${data.isCorrect ? 'correct' : 'wrong'}`;
      const pointsText = data.points > 0 ? `+${data.points}åˆ†` : `${data.points}åˆ†`;
      feedback.innerHTML = `
        <strong>${data.isCorrect ? 'âœ… å›ç­”æ­£ç¡®!' : 'âŒ å›ç­”é”™è¯¯'}</strong><br>
        ${data.isCorrect ? `æ­å–œæ‚¨è·å¾— ${pointsText}!` : `æ‰£é™¤15åˆ†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${String.fromCharCode(65 + data.correctAnswer)}`}<br>
        å½“å‰æ€»åˆ†: ${data.totalScore}åˆ†
      `;
      feedback.style.display = 'block';

      // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
      options.forEach(option => {
        option.style.pointerEvents = 'none';
      });
    }

    // æ˜¾ç¤ºè¶…æ—¶åé¦ˆ
    function showTimeUpFeedback(data) {
      const feedback = document.getElementById('answerFeedback');
      const options = document.querySelectorAll('.option');

      // æ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
      options.forEach((option, index) => {
        if (index === data.correctAnswer) {
          option.classList.add('correct');
        }
      });

      // æ˜¾ç¤ºåé¦ˆä¿¡æ¯
      feedback.className = 'answer-feedback wrong';
      feedback.innerHTML = `
        <strong>â° ${data.message}</strong><br>
        æ‰£é™¤15åˆ†ï¼Œæ­£ç¡®ç­”æ¡ˆæ˜¯ ${String.fromCharCode(65 + data.correctAnswer)}<br>
        å½“å‰æ€»åˆ†: ${data.totalScore}åˆ†
      `;
      feedback.style.display = 'block';

      // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
      options.forEach(option => {
        option.style.pointerEvents = 'none';
      });
    }

    // å¼€å§‹é¢˜ç›®è®¡æ—¶å™¨
    function startQuestionTimer() {
      const timerElement = document.getElementById('questionTimer');

      questionTimer = setInterval(() => {
        timeLeft--;
        timerElement.textContent = `${timeLeft}s`;

        // æ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜é¢œè‰²
        if (timeLeft <= 3) {
          timerElement.style.background = 'linear-gradient(135deg, #ff1744 0%, #f50057 100%)';
          timerElement.style.animation = 'pulse 0.5s infinite alternate';
        } else if (timeLeft <= 5) {
          timerElement.style.background = 'linear-gradient(135deg, #ff9800 0%, #ff5722 100%)';
        } else {
          timerElement.style.background = 'linear-gradient(135deg, #4caf50 0%, #8bc34a 100%)';
          timerElement.style.animation = 'none';
        }

        if (timeLeft <= 0) {
          clearInterval(questionTimer);
          questionTimer = null;
          // æœåŠ¡å™¨ä¼šè‡ªåŠ¨å¤„ç†è¶…æ—¶ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–æ“ä½œ
        }
      }, 1000);
    }

    // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    function updateScore(score) {
      const scoreDisplays = document.querySelectorAll('#scoreDisplay');
      scoreDisplays.forEach(element => {
        if (element) element.textContent = score;
      });

      const currentScoreElement = document.getElementById('currentScore');
      if (currentScoreElement) {
        currentScoreElement.querySelector('.score').textContent = score;
      }
    }

    // æ›´æ–°æ’å
    function updateRank(leaderboard) {
      if (!currentUser) return;

      const myRank = leaderboard.findIndex(user => user.studentId === currentUser.studentId) + 1;
      const rankDisplays = document.querySelectorAll('#rankDisplay');
      rankDisplays.forEach(element => {
        if (element) element.textContent = myRank > 0 ? `ç¬¬${myRank}å` : '-';
      });
    }

    // æ˜¾ç¤ºç»“æœ
    function showResults(leaderboard) {
      const myData = leaderboard.find(user => user.studentId === currentUser.studentId);

      if (myData) {
        document.getElementById('finalScore').textContent = myData.score;
        document.getElementById('finalRank').textContent = `æ‚¨çš„æ’å: ç¬¬ ${myData.rank} å`;
      }

      // æ˜¾ç¤ºå‰ä¸‰å
      const topThree = document.getElementById('topThree');
      topThree.innerHTML = leaderboard.slice(0, 3).map((user, index) => {
        const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
        return `
          <div class="leaderboard-item">
            <span>${medals[index]} ${user.name}(${user.studentId})</span>
            <span>${user.score}åˆ†</span>
          </div>
        `;
      }).join('');

      // ç¦ç”¨é¡µé¢æ“ä½œï¼Œé˜²æ­¢ç”¨æˆ·å°è¯•é‡æ–°å¼€å§‹
      document.body.style.pointerEvents = 'none';
      document.querySelector('.result-container').style.pointerEvents = 'auto';
    }

    // ç§»åŠ¨ç«¯å…¼å®¹æ€§å¤„ç†
    document.addEventListener('touchstart', function () { }, true);

    // å›è½¦é”®æäº¤æ˜µç§°
    nameInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        joinGame();
      }
    });

    // é¡µé¢åˆå§‹åŒ–
    window.addEventListener('load', () => {
      log('é¡µé¢åŠ è½½å®Œæˆ');
      log(`User Agent: ${navigator.userAgent}`);
      log(`æ˜¯å¦å¾®ä¿¡æµè§ˆå™¨: ${/micromessenger/i.test(navigator.userAgent)}`);

      nameInput.focus();

      // æ£€æŸ¥Socket.ioæ˜¯å¦åŠ è½½æˆåŠŸ
      if (typeof io === 'undefined') {
        log('é”™è¯¯: Socket.ioæœªåŠ è½½æˆåŠŸ');
        alert('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      } else {
        log('Socket.ioåŠ è½½æˆåŠŸ');
      }
    });

    // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆå¾®ä¿¡åˆ‡æ¢åº”ç”¨æ—¶ï¼‰
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible') {
        log('é¡µé¢å˜ä¸ºå¯è§');
        if (socket.disconnected) {
          socket.connect();
        }
      } else {
        log('é¡µé¢å˜ä¸ºéšè—');
      }
    });
  </script>
</body>

</html>